<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.anamensis.server.mapper.ChatRoomMapper">

    <select id="selectById" resultMap="ChatRoomResultMap">
        SELECT *
             , cr.id         AS chat_room_pk
             , cr.type       AS chat_room_type
             , cr.created_at AS chat_room_created_at
             , cr.updated_at AS chat_room_updated_at
             , m1.id         AS member_pk
             , m1.user_id    AS member_user_id
             , m1.create_at  AS member_create_at
             , f.id          AS file_pk
             , m2.id         AS host_pk
             , m2.user_id    AS host_user_id
             , m2.create_at  AS host_create_at
          FROM chat_room cr
          JOIN chat_room_user cru1
            ON cr.id = cru1.chat_room_id
          JOIN member m1
            ON cru1.user_id = m1.id
          LEFT JOIN file f
            ON f.table_ref_pk = m1.id
           AND f.table_code_pk = (SELECT id
                                    FROM table_code
                                   WHERE table_name = 'member')
          JOIN member m2
            ON cr.host_id = m2.id
         WHERE cr.id = #{id};
    </select>

    <select id="selectAll" resultMap="ChatRoomResultMap">
        SELECT *
             , cr.id         AS chat_room_pk
             , cr.type       AS chat_room_type
             , cr.created_at AS chat_room_created_at
             , cr.updated_at AS chat_room_updated_at
             , m1.id         AS member_pk
             , m1.user_id    AS member_user_id
             , m1.create_at  AS member_create_at
             , f.id          AS file_pk
             , m2.id         AS host_pk
             , m2.user_id    AS host_user_id
             , m2.create_at  AS host_create_at
          FROM chat_room cr
          JOIN chat_room_user cru1
               ON cr.id = cru1.chat_room_id
          JOIN member m1
               ON cru1.user_id = m1.id
          LEFT JOIN file f
            ON f.table_ref_pk = m1.id
           AND f.table_code_pk = (SELECT id
                                    FROM table_code
                                   WHERE table_name = 'member')
          JOIN member m2
            ON cr.host_id = m2.id
         WHERE cr.id IN (SELECT cru1.chat_room_id
                           FROM chat_room_user
                          WHERE user_id = (SELECT id
                                             FROM member
                                            WHERE user_id = #{userId}
                                          )
                         )
        ORDER BY cr.updated_at DESC
    </select>

    <select id="chatRoomIdByUsers" resultMap="ChatRoomUserCount">
        SELECT cru1.chat_room_id AS id
             , (SELECT count(*)
                  FROM chat_room_user cru3
                 WHERE cru3.chat_room_id = cru1.chat_room_id
             ) AS user_count
          FROM anamensis.chat_room_user cru1
          JOIN anamensis.chat_room_user cru2
            ON cru2.chat_room_id = cru1.chat_room_id
           AND cru2.user_id = (SELECT id
                                 FROM anamensis.member
                                WHERE user_id = #{firstUserId})
         WHERE cru1.user_id = (SELECT id
                                 FROM anamensis.member
                                WHERE user_id = #{secondUserId})
    </select>

    <select id="validateChatRoomByUserId" resultType="boolean">
        SELECT EXISTS(SELECT 1
                        FROM chat_room_user
                       WHERE chat_room_id = #{chatRoomId}
                         AND user_id = (SELECT id
                                          FROM member
                                         WHERE user_id = #{userId}
                                       )
                     )
    </select>

    <insert id="save" parameterType="ChatRoom">
        <selectKey keyProperty="id" resultType="long" order="AFTER">
            SELECT currval('chat_room_id_seq')
        </selectKey>
        INSERT INTO chat_room (name, type, host_id, last_message, created_at, updated_at)
        VALUES (#{name}, #{type}, #{hostId}, #{lastMessage}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateLastMessage" parameterType="ChatRoom">
        UPDATE chat_room
           SET last_message = #{lastMessage}
             , updated_at   = now()
         WHERE id           = #{id}
    </update>

    <insert id="saveChatRoomUser">
        INSERT INTO chat_room_user (chat_room_id, user_id)
        <foreach collection="userIds" item="userId" separator="," open="VALUES">
            (#{chatRoomId}, #{userId})
        </foreach>
    </insert>

    <resultMap id="ChatRoomUserCount" type="com.anamensis.server.resultMap.ChatRoomResultMap$ChatRomeUserCount">
        <id property="id" column="id"/>
        <result property="userCount" column="user_count"/>
    </resultMap>

    <resultMap id="ChatRoomResultMap" type="com.anamensis.server.resultMap.ChatRoomResultMap$ChatRoom">
        <id property="id" column="chat_room_pk"/>
        <association property="chatRoom" resultMap="ChatRoomEntity"/>
        <association property="host" resultMap="HostEntity"/>
        <collection property="participants" resultMap="memberListItemResultMap" />
    </resultMap>

    <resultMap id="HostEntity" type="Member" autoMapping="true">
        <id property="id" column="host_pk"/>
        <result property="userId" column="host_user_id"/>
        <result property="createAt" column="host_create_at" />
    </resultMap>

    <resultMap id="memberListItemResultMap" type="com.anamensis.server.resultMap.MemberResultMap$ListItem">
        <id property="memberPk" column="member_pk"/>
        <association property="member" resultMap="MemberEntity" autoMapping="true" />
        <association property="file" resultMap="FileEntity" autoMapping="true" />
    </resultMap>

    <resultMap id="FileEntity" type="File" autoMapping="true">
        <id property="id" column="file_pk"/>
    </resultMap>

    <resultMap id="MemberEntity" type="Member" autoMapping="true">
        <id property="id" column="member_pk"/>
        <result property="userId" column="member_user_id"/>
        <result property="createAt" column="member_create_at" />
    </resultMap>
    <resultMap id="ChatRoomRowEntity" type="ChatRoom" autoMapping="true">
        <result property="type" column="type" typeHandler="RoomTypeHandler"/>
    </resultMap>
    <resultMap id="ChatRoomEntity" type="ChatRoom" autoMapping="true">
        <id property="id" column="chat_room_pk"/>
        <result property="hostId" column="host_pk"/>
        <result property="type" column="chat_room_type" typeHandler="RoomTypeHandler"/>
        <result property="createdAt" column="chat_room_created_at"/>
        <result property="updatedAt" column="chat_room_updated_at"/>
    </resultMap>
    <resultMap id="ChatMessageEntity" type="ChatMessage" autoMapping="true">
        <id property="id" column="chat_message_pk"/>
        <result property="createdAt" column="chat_message_created_at"/>
    </resultMap>

</mapper>