<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.anamensis.server.mapper.PointHistoryMapper">
    <select id="selectByPointHistory" resultMap="pointHistoryResultMap">
        SELECT *
          FROM point_history ph
          JOIN point_code pc
            ON ph.point_code_pk = pc.id
        <if test="param.pointCodeName != null and param.pointCodeName != ''">
           AND pc.name = #{param.pointCodeName}
        </if>
          JOIN table_code tc
            ON ph.table_code_pk = tc.id
        <if test="param.tableName != null and param.tableName != ''">
           AND tc.table_name = #{param.tableName}
        </if>
         WHERE 1 = 1
        <if test="param.id != 0">
           AND ph.id = #{param.id}
        </if>
        <if test="param.tableRefPk != 0">
           AND ph.table_ref_pk = #{param.tableRefPk}
        </if>
        <if test="param.memberPk != 0">
           AND ph.member_pk = #{param.memberPk}
        </if>
        ORDER BY ph.id DESC
        LIMIT #{page.offset}, #{page.size}
    </select>

    <insert id="insert" parameterType="PointHistory">
        INSERT INTO point_history
               (table_code_pk, table_ref_pk, member_pk, point_code_pk, create_at)
        VALUES (#{tableCodePk}, #{tableRefPk}, #{memberPk}, #{pointCodePk}, #{createAt})
    </insert>

    <resultMap id="pointHistoryResultMap" type="PointHistoryResultMap">
        <id property="id" column="id"/>
        <association property="pointHistory" resultMap="pointHistoryEntity" autoMapping="true" />
        <association property="pointCode" resultMap="pointCodeEntity" autoMapping="true" />
        <association property="tableCode" resultMap="tableCodeEntity" autoMapping="true" />
    </resultMap>
    <resultMap id="pointHistoryEntity" type="PointHistory" />
    <resultMap id="pointCodeEntity" type="PointCode" />
    <resultMap id="tableCodeEntity" type="TableCode" />
</mapper>